<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARCOIRIS DE LUCES</title>

  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark: #052f26;
      --string-color: #fff;
      --bulb-size:96px;
      --font: "EB Garamond", "Garamond", serif;
    }
    
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg,#6c0f14 0%, #7b1220 45%, #3a0710 100%);
      color:#fff
    }

 
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding:40px 20px 24px;
      overflow-x:hidden;
    }

    .stars{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
    }
    .star{
      position:absolute;
      background:#fff;
      border-radius:50%;
      opacity:.3;
      animation: twinkle 3s infinite ease-in-out;
    }
    @keyframes twinkle{
      0%,100%{opacity:.25; transform:scale(1)}
      50%{opacity:1; transform:scale(1.2)}
    }

    #preloader{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
      background:linear-gradient(180deg,#6c0f14 0%, #7b1220 45%, #3a0710 100%);
      transition:opacity .5s ease, visibility .5s ease;
    }
    #preloader.hidden{
      opacity:0;
      visibility:hidden;
    }
    .loader-content{ text-align:center; z-index:2; }
    .loader-logo{
      width:300px;
      height:auto;
      margin-bottom:18px;
      filter: drop-shadow(0 0 20px rgba(255,215,0,.35));
    }
    .loader-text{
      font-size:20px;
      font-weight:800;
      letter-spacing:1px;
      margin-bottom:18px;
      color:#FFD700;
      text-shadow:0 0 20px rgba(255,215,0,.35);
    }
    .progress-bar-container{
      width:280px;
      height:8px;
      background:rgba(255,255,255,.1);
      border-radius:10px;
      overflow:hidden;
      border:2px solid rgba(255,215,0,.25);
    }
    .progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#FFD700,#FFA500,#FFD700);
      background-size:200% 100%;
      animation: shimmer 2s infinite;
      transition:width .25s ease;
    }
    @keyframes shimmer{
      0%{background-position:-100% 0}
      100%{background-position:100% 0}
    }

    .container{
      opacity:0;
      transition:opacity .5s ease;
      width:100%;
      display:flex;
      justify-content:center;
    }
    .container.visible{ opacity:1; }

    .trees-layer{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }
    .tree{
      position:absolute;
      pointer-events:none;
      user-select:none;
      will-change:transform, opacity;
      opacity:0.85;
      filter:drop-shadow(0 6px 8px rgba(0,0,0,0.35));
      transform-origin:center;
      transition:transform 600ms ease, opacity 400ms ease;
    }
    .tree.animate{
      animation: floatTiny 6s ease-in-out infinite;
    }
    @keyframes floatTiny{
      0%{ transform: translateY(0) rotate(var(--rot)); }
      50%{ transform: translateY(-6px) rotate(calc(var(--rot) + 2deg)); }
      100%{ transform: translateY(0) rotate(var(--rot)); }
    }

    .stage{
      width:100%;
      max-width:1100px;
      position:relative;
      padding:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      z-index:3;
      margin-top:clamp(10px,4vh,40px); 
    }

    .topbar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      margin-bottom:6px
    }

    .game-logo{
      width:200px;
      height:auto;
      margin-bottom:80px;  
      filter: drop-shadow(0 0 18px rgba(255,215,0,.25));
    }

    .title{
      font-size:34px;
      margin:0;
      line-height:1;
      font-weight:800;
      letter-spacing:1px;
      background: linear-gradient(90deg,#ff3b30,#ff9500,#ffd300,#43a047,#1e88e5,#8e24aa);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-transform:uppercase;
      text-align:center;
      text-shadow: 0 4px 18px rgba(0,0,0,0.45);
    }
    .subtitle{
      margin:0;
      color:rgba(255,255,255,0.95);
      font-size:13px;
      letter-spacing:1.4px;
      text-transform:uppercase;
      font-weight:700;
      text-align:center;
    }

    .svg-wrapper{
      position:relative;
      width:100%;
      height:340px;
      overflow:hidden; 
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 12px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.02);
    }
    svg.garland{
      position:relative;
      width:92%;
      height:100%;
      pointer-events:none;
      z-index:1
    }
    .lights{
      position:absolute;
      left:0;
      top:0;
      width:100%;
      height:100%;
      pointer-events:auto;
      z-index:2
    }

    .bulb{
      position:absolute;
      width:var(--bulb-size);
      height:var(--bulb-size);
      margin-left:calc(var(--bulb-size)/-2);
      margin-top:calc(var(--bulb-size)/-2);
      pointer-events:auto;
      border:0;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      touch-action:manipulation;
      outline:none;
      border-radius:50%;
      transition:transform .18s ease, opacity .18s ease, filter .18s ease;
    }
    .bulb:focus{
      box-shadow:0 0 0 10px rgba(255,255,255,0.06);
      border-radius:50%;
    }

   
    .bulb::before{
      content:"";
      position:absolute;
      top:calc(-1 * var(--bulb-size) * 0.50);
      left:50%;
      transform:translateX(-50%);
      width:5px;
      height:calc(var(--bulb-size) * 0.42);
      background:var(--string-color);
      border-radius:2px;
      z-index:6;
    }

    .bulb .glow{
      position:absolute;
      width:140%;
      height:140%;
      border-radius:50%;
      filter:blur(14px);
      z-index:1;
      transform:translateY(6px);
      transition:opacity .18s ease, transform .18s ease;
    }
    .bulb .art{
      width:86%;
      height:86%;
      transform-origin:center;
      display:block;
      z-index:7;
      transition:transform .18s ease
    }
    .bulb .cap{
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      width:40%;
      height:12%;
      background:linear-gradient(180deg,#fff,#ddd);
      border-radius:4px;
      z-index:8
    }

    .bulb:hover{transform:translateY(-8px) scale(1.02)}
    .bulb.revealed{opacity:1;transform:scale(1.06)}
    .bulb.revealed .glow{opacity:0.6}

    .btn{
      background:#0b6b4a;
      color:#fff;
      border:0;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-family:var(--font);
      font-size:15px;
    }

    .modal .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: linear-gradient(135deg,#FFD700,#FFA500);
      color:#5b0111;
      border:none;
      padding:14px 20px;
      font-weight:800;
      border-radius:999px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.55);
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s ease, opacity .14s ease;
      text-transform:uppercase;
      letter-spacing:1px;
      font-size:16px;
      min-width:130px;
      justify-content:center;
    }

    .modal .btn::before{
      content: "‚úì";
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:30px;
      height:30px;
      border-radius:50%;
      background:rgba(255,255,255,0.18);
      color:#5b0111;
      font-weight:900;
      font-size:15px;
      transform:translateY(-1px);
    }

    .modal .btn:hover{
      transform:translateY(-3px) scale(1.02);
      box-shadow: 0 18px 48px rgba(0,0,0,0.7);
    }
    .modal .btn:active{ transform:translateY(0); }
    .modal .btn:focus{
      outline: 3px solid rgba(255,215,0,0.45);
      outline-offset:3px;
    }

    
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.50);
      backdrop-filter:blur(6px);
      z-index:40;
      animation: fadeIn 0.25s ease-out;
    }
    .modal.show{display:flex}

    .modal-card{
      width:420px;
      max-width:94%;
      padding:32px 26px;
      border-radius:22px;
      background:linear-gradient(135deg,#2d0812 0%,#5a0e1f 45%,#7b1220 100%);
      color:#fff;
      text-align:center;
      box-shadow:0 22px 70px rgba(0,0,0,0.8);
      border:3px solid #FFD700;
      position:relative;
      overflow:hidden;
      animation: modalIn 0.45s cubic-bezier(0.68,-0.55,0.265,1.55);
    }

    .modal-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 10% 0%,rgba(255,215,0,0.18),transparent 55%),
                 radial-gradient(circle at 90% 100%,rgba(255,90,90,0.22),transparent 55%);
      opacity:0.9;
      pointer-events:none;
    }
    .modal-card > *{ position:relative; z-index:1; }

    .modal-title{
      margin:0;
      font-size:24px;
      letter-spacing:1px;
      text-transform:uppercase;
      color:#FFD700;
      text-shadow:0 0 20px rgba(255,215,0,0.7);
    }
    .modal-sub{
      color:rgba(255,255,255,0.92);
      margin:12px 0 6px;
      font-size:15px;
      letter-spacing:0.5px;
    }
    .modal-bonus{
      font-size:32px;
      font-weight:800;
      margin:14px 0 4px;
      color:#FFD700;
      text-shadow:0 0 24px rgba(255,215,0,1);
    }

    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }
    @keyframes modalIn{
      0%{transform:scale(0.7) translateY(30px); opacity:0;}
      60%{transform:scale(1.03) translateY(0); opacity:1;}
      100%{transform:scale(1); opacity:1;}
    }

    /* confetti */
    .confetti-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:95
    }
    .confetti{
      position:absolute;
      width:8px;
      height:12px;
      border-radius:2px;
      animation:fall 1200ms forwards cubic-bezier(.2,.8,.25,1)
    }
    @keyframes fall{
      0%{opacity:1;transform:translateY(-10px) rotate(0deg)}
      100%{opacity:1;transform:translateY(160vh) rotate(540deg)}
    }

    
    @media (max-width:900px){
      :root{--bulb-size:76px}
      .svg-wrapper{height:300px}
      .title{font-size:30px}
      .modal-card{width:360px}
      .game-logo{ width:180px; margin-bottom:60px; }
    }
    @media (max-width:520px){
      :root{--bulb-size:56px}

      body{ padding:24px 10px 16px; }
      .stage{ padding:10px; margin-top:16px; }

      .svg-wrapper{
        height:260px;
        padding:4px 4px;
      }

      svg.garland{ width:100%; }

      .title{font-size:22px}
      .subtitle{font-size:12px}
      .game-logo{ width:170px; margin-bottom:40px; }

      .modal-card{
        width:calc(100% - 32px);
        margin:0 16px;
        border-radius:18px;
        padding:24px 18px;
        box-shadow: 0 16px 45px rgba(0,0,0,0.8);
      }

      .modal .btn{
        padding:14px 18px;
        font-size:15px;
        min-width:120px;
      }

      .bulb::before{ width:4px; }
      .modal-card .modal-bonus{ font-size:26px; }
    }

    @media (max-width:400px){
      :root{--bulb-size:50px}
      .svg-wrapper{height:220px}
      .title{font-size:20px}
      .modal .btn{
        padding:12px 16px;
        font-size:14px;
        min-width:110px;
      }
      .tree.animate{ animation: none; }
    }
  </style>
</head>

<body>

  <div class="stars" id="stars" aria-hidden="true"></div>

  <div id="preloader" aria-hidden="false">
    <div class="loader-content">
      <img src="assets/image.png" alt="Logo" class="loader-logo">
      <div class="loader-text">CARGANDO...</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="loaderProgress"></div>
      </div>
    </div>
  </div>

  <div class="container" id="mainContainer">
    <div id="trees" class="trees-layer" aria-hidden="true"></div>

    <main class="stage" role="application" aria-label="Guirnalda interactiva">
      <header class="topbar" role="banner">
        <img src="assets/image.png" alt="Logo" class="game-logo">
        <h1 class="title">ARCOIRIS DE LUCES</h1>
        <p class="subtitle">¬øCUAL SER√Å TU BONO DE LUZ?</p>
      </header>

      <div class="svg-wrapper" aria-hidden="false">
        <svg id="garlandSVG" class="garland" viewBox="0 0 1200 360" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <path id="garlandPath" d="M20,60 C160,10 300,220 440,120 C580,20 720,220 860,120 C980,50 1060,170 1180,120"
                stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round" />
        </svg>

        <div id="lights" class="lights" role="list" aria-label="Luces de la guirnalda"></div>
      </div>
    </main>

    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
      <div class="modal-card" role="document">
        <h2 id="modal-title" class="modal-title">¬°Felicidades!</h2>
        <p class="modal-sub">Te ganaste un bono de</p>
        <p id="modal-bonus" class="modal-bonus">--</p>
        <div style="margin-top:18px">
          <button id="modal-ok" class="btn">Aceptar</button>
        </div>
      </div>
    </div>

    <div id="confetti" class="confetti-layer" aria-hidden="true"></div>

    <audio id="tapSound" src="assets/tap.mp3" preload="auto"></audio>
    <audio id="popupSound" src="assets/popup.mp3" preload="auto"></audio>
    <audio id="bgMusic" src="assets/background-music.mp3" preload="auto" loop></audio>

  </div><!-- /#mainContainer -->

  <script>
    
    (function createStars(){
      const stars = document.getElementById('stars');
      if(!stars) return;
      const count = 90;
      for(let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random()*100 + '%';
        s.style.top  = Math.random()*100 + '%';
        const size = (Math.random()*2.5 + 1).toFixed(2);
        s.style.width = size + 'px';
        s.style.height = size + 'px';
        s.style.animationDelay = (Math.random()*3).toFixed(2) + 's';
        stars.appendChild(s);
      }
    })();

    document.addEventListener('DOMContentLoaded', () => {
      const preloader = document.getElementById('preloader');
      const mainContainer = document.getElementById('mainContainer');
      const loaderProgress = document.getElementById('loaderProgress');

      let p = 0;
      const i = setInterval(() => {
        p += Math.random()*15 + 10;
        if(p >= 100){
          p = 100;
          if(loaderProgress) loaderProgress.style.width = '100%';
          clearInterval(i);

          setTimeout(() => {
            if(preloader) preloader.classList.add('hidden');
            if(mainContainer) mainContainer.classList.add('visible');
            initGuirnalda();
          }, 450);
        } else {
          if(loaderProgress) loaderProgress.style.width = p + '%';
        }
      }, 180);
    });

    function initGuirnalda(){
      try {
        // LocalStorage
        const STORAGE_KEY = 'arcoirisLucesSpirita_v1';

        const BONUSES = [
          { label: "100% de bono", weight: 0.50 },
          { label: "150% de bono", weight: 0.35 },
          { label: "200% de bono", weight: 0.15 }
        ];

        const RAINBOW = ['#8e24aa','#1e88e5','#43a047','#fdd835','#fb8c00','#e53935','#ff4081','#ffd54f','#81d4fa'];
        const BULB_COUNT = 9;

        const svg = document.getElementById('garlandSVG');
        const path = document.getElementById('garlandPath');
        const lights = document.getElementById('lights');
        const modal = document.getElementById('modal');
        const modalBonus = document.getElementById('modal-bonus');
        const modalOk = document.getElementById('modal-ok');
        const confettiLayer = document.getElementById('confetti');
        const treesLayer = document.getElementById('trees');
        const stageEl = document.querySelector('.stage');

        const tapSound = document.getElementById('tapSound');
        const popupSound = document.getElementById('popupSound');
        const bgMusic = document.getElementById('bgMusic');
        let bgStarted = false;

        function playSfx(audioEl, vol = 0.7){
          if(!audioEl) return;
          try{
            audioEl.pause();
            audioEl.currentTime = 0;
            audioEl.volume = vol;
            audioEl.play().catch(()=>{});
          } catch(e){}
        }
        function startBgMusic(){
          if(!bgMusic || bgStarted) return;
          bgMusic.volume = 0.30;
          bgMusic.play().catch(()=>{});
          bgStarted = true;
        }

        // 
        const handleUserInteract = () => {
          startBgMusic();
          document.removeEventListener('pointerdown', handleUserInteract);
          document.removeEventListener('keydown', handleUserInteract);
        };
        document.addEventListener('pointerdown', handleUserInteract);
        document.addEventListener('keydown', handleUserInteract);

        if(!svg || !path || !lights) {
          console.error('Elemento necesario no encontrado en el DOM.');
          return;
        }

        // 
        (svg.querySelectorAll('g.bulb-svg, foreignObject, line.hanger') || []).forEach(n => n.remove());

        const todayStr = () => {
          const d = new Date();
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };
        function getStoredChoice(){
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if(!raw) return null;
            return JSON.parse(raw);
          } catch(e){ return null; }
        }
        function setStoredChoice(bonus, index){
          try {
            const item = { bonus, index, date: todayStr(), ts: Date.now() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(item));
          } catch(e){}
        }
        function hasChosenToday(){
          const st = getStoredChoice();
          return st && st.date === todayStr();
        }

        function hexToRgba(hex, a=0.28){
          const c = hex.replace('#','');
          const r = parseInt(c.substring(0,2),16);
          const g = parseInt(c.substring(2,4),16);
          const b = parseInt(c.substring(4,6),16);
          return `rgba(${r},${g},${b},${a})`;
        }
        function bulbSVG(color){
          return `
            <svg class="inner" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
              <rect x="20" y="4" rx="6" ry="6" width="24" height="12" fill="#fff" stroke="#111" stroke-width="2"/>
              <path d="M32 10 C34 10 36 12 36 14" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round"/>
              <circle cx="32" cy="38" r="18" fill="${color}" stroke="#111" stroke-width="3" />
              <path d="M45 29 C42 24 36 22 32 25" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `;
        }
        function weightedPick(bonuses) {
          let sum = 0;
          const cumulative = bonuses.map(b => { sum += b.weight; return { label: b.label, cum: sum }; });
          const r = Math.random() * sum;
          for (let i = 0; i < cumulative.length; i++) {
            if (r <= cumulative[i].cum) return cumulative[i].label;
          }
          return cumulative[cumulative.length - 1].label;
        }

        function assignBonuses(){
          const bulbs = document.querySelectorAll('.bulb');
          bulbs.forEach((b, i) => {
            const pick = weightedPick(BONUSES);
            const color = RAINBOW[i % RAINBOW.length];
            b.dataset.bonus = pick;
            b.dataset.index = String(i);

            const glow = b.querySelector('.glow');
            if(glow) glow.style.background = hexToRgba(color, 0.36);

            const art = b.querySelector('.art');
            if(art) art.innerHTML = bulbSVG(color);

            b.classList.remove('revealed');
          });
        }

        function createBulbs(n){
          lights.innerHTML = '';
          for(let i=0;i<n;i++){
            const btn = document.createElement('button');
            btn.className = 'bulb';
            btn.type = 'button';
            btn.setAttribute('role','listitem');
            btn.tabIndex = 0;

            const glow = document.createElement('div');
            glow.className = 'glow';
            btn.appendChild(glow);

            const art = document.createElement('div');
            art.className = 'art';
            btn.appendChild(art);

            btn.addEventListener('click', onBulbClick);
            btn.addEventListener('keydown', (e) => {
              if(e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                onBulbClick({ currentTarget: btn });
              }
            });

            lights.appendChild(btn);
          }
          assignBonuses();
          positionBulbsDeferred();

          window.removeEventListener('resize', positionBulbsDeferred);
          window.addEventListener('resize', positionBulbsDeferred);
          window.removeEventListener('orientationchange', positionBulbsDeferred);
          window.addEventListener('orientationchange', positionBulbsDeferred);
        }

        function positionBulbs(){
          const nodes = Array.from(document.querySelectorAll('.bulb'));
          if(!path || !svg || nodes.length === 0) return;

          const L = path.getTotalLength();
          const svgRect = svg.getBoundingClientRect();
          const vb = svg.viewBox.baseVal;
          const containerRect = lights.getBoundingClientRect();

          let ctm = null;
          try { ctm = svg.getScreenCTM(); } catch(e){ ctm = null; }
          const hasCTM = !!ctm && typeof svg.createSVGPoint === 'function';

          const cssBulb = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bulb-size')) || 96;
          const isMobile = (window.innerWidth || document.documentElement.clientWidth) < 520;
          const offsetPx = Math.max(cssBulb * (isMobile ? 0.16 : 0.20), isMobile ? 10 : 18);

          nodes.forEach((el, idx) => {
            const start = (window.innerWidth < 520) ? 0.03 : 0.06;
            const end   = (window.innerWidth < 520) ? 0.97 : 0.94;

            const t = (nodes.length === 1)
              ? 0.5
              : start + (idx / (nodes.length - 1)) * (end - start);

            const svgPoint = path.getPointAtLength(t * L);

            if(hasCTM){
              const pt = svg.createSVGPoint();
              pt.x = svgPoint.x; pt.y = svgPoint.y;
              let screenPoint;
              try { screenPoint = pt.matrixTransform(ctm); } catch(e){ screenPoint = null; }

              if(screenPoint){
                const delta = Math.max(1, L * 0.002);
                const p1 = path.getPointAtLength(Math.max(0, t*L - delta));
                const p2 = path.getPointAtLength(Math.min(L, t*L + delta));
                pt.x = p1.x; pt.y = p1.y; const s1 = pt.matrixTransform(ctm);
                pt.x = p2.x; pt.y = p2.y; const s2 = pt.matrixTransform(ctm);
                const dx = s2.x - s1.x, dy = s2.y - s1.y;
                const len = Math.hypot(dx, dy) || 1;
                const nx = -dy / len, ny = dx / len;

                const screenX = screenPoint.x + nx * offsetPx;
                const screenY = screenPoint.y + ny * offsetPx;

                el.style.left = (screenX - containerRect.left) + 'px';
                el.style.top  = (screenY - containerRect.top) + 'px';

                const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
                const art = el.querySelector('.art');
                if(art) art.style.transform = `translateY(6px) rotate(${-angle}deg)`;
                return;
              }
            }

            const scaleX = svgRect.width / (vb.width || svgRect.width);
            const scaleY = svgRect.height / (vb.height || svgRect.height);

            const delta = Math.max(1, L * 0.002);
            const p1 = path.getPointAtLength(Math.max(0, t*L - delta));
            const p2 = path.getPointAtLength(Math.min(L, t*L + delta));

            const dx = (p2.x - p1.x) * scaleX;
            const dy = (p2.y - p1.y) * scaleY;
            const len = Math.hypot(dx, dy) || 1;
            const nx = -dy / len, ny = dx / len;

            const screenX = svgRect.left + svgPoint.x * scaleX + nx * offsetPx;
            const screenY = svgRect.top  + svgPoint.y * scaleY + ny * offsetPx;
            el.style.left = (screenX - containerRect.left) + 'px';
            el.style.top  = (screenY - containerRect.top) + 'px';

            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
            const art = el.querySelector('.art');
            if(art) art.style.transform = `translateY(6px) rotate(${-angle}deg)`;
          });
        }

        function positionBulbsDeferred(){
          window.requestAnimationFrame(()=>{ setTimeout(()=> positionBulbs(), 60); });
        }

        function showModalWith(bonus){
          const title = modal.querySelector('.modal-title');
          const sub = modal.querySelector('.modal-sub');
          if(title) title.textContent = '¬°Felicidades!';
          if(sub) sub.textContent = 'Te ganaste un bono de';
          modalBonus.textContent = bonus;
          modal.classList.add('show');
          modal.setAttribute('aria-hidden','false');
          playSfx(popupSound, 0.9);
        }

        function showStoredModal(bonus){
          const title = modal.querySelector('.modal-title');
          const sub = modal.querySelector('.modal-sub');
          if(title) title.textContent='Tu bono de hoy';
          if(sub) sub.textContent='Hoy ya jugaste. Este fue tu bono:';
          modalBonus.textContent = bonus;
          modal.classList.add('show');
          modal.setAttribute('aria-hidden','false');
          playSfx(popupSound, 0.7);
        }

        function onBulbClick(e){
          const btn = e.currentTarget;
          if(!btn) return;

          
          startBgMusic();
          playSfx(tapSound, 0.85);

          const stored = getStoredChoice();
          if(stored && stored.date === todayStr()){
           
            showStoredModal(stored.bonus);
            return;
          }

 
          btn.classList.add('revealed');

          const bonus = btn.dataset.bonus || weightedPick(BONUSES);
          const bulbs = Array.from(document.querySelectorAll('.bulb'));
          const index = bulbs.indexOf(btn);
          setStoredChoice(bonus, index);

          showModalWith(bonus);
          createConfettiAtElement(btn);
        }

        function createConfettiAtElement(el){
          const rect = el.getBoundingClientRect();
          const cx = rect.left + rect.width/2;
          const cy = rect.top + rect.height/2;
          const colors = ['#ff3b30','#ff9500','#ffcc00','#34c759','#5ac8fa','#5856d6','#ff2d55'];
          const isMobile = (window.innerWidth || document.documentElement.clientWidth) < 520;
          const count = isMobile ? 12 : 30;

          for(let i=0;i<count;i++){
            const p = document.createElement('div');
            p.className = 'confetti';
            p.style.left = (cx + (Math.random()-0.5)*(isMobile?80:140)) + 'px';
            p.style.top = (cy + (Math.random()-0.5)*(isMobile?40:100)) + 'px';
            p.style.background = colors[Math.floor(Math.random()*colors.length)];
            p.style.width = (4 + Math.random()*8) + 'px';
            p.style.height = (6 + Math.random()*10) + 'px';
            p.style.borderRadius = (Math.random()>0.6 ? '2px' : '50%');
            p.style.animationDelay = (Math.random()*200) + 'ms';
            confettiLayer.appendChild(p);
            setTimeout(()=> p.remove(), 1100 + Math.random()*600);
          }
        }

        function createTrees(count = 40){
          if(!treesLayer || !stageEl) return;
          treesLayer.innerHTML = '';

          const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
          const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
          const isVerySmall = vw <= 420;

          const stageRect = stageEl.getBoundingClientRect();
          const marginPx = Math.max(12, Math.min(vw * 0.06, 48));
          const excl = {
            left: Math.max(0, stageRect.left - marginPx),
            top: Math.max(0, stageRect.top - marginPx),
            right: Math.min(vw, stageRect.right + marginPx),
            bottom: Math.min(vh, stageRect.bottom + marginPx)
          };

          const maxAttempts = 80;

          for(let i=0;i<count;i++){
            let attempts = 0, placed=false;
            while(!placed && attempts<maxAttempts){
              attempts++;
              const x = Math.random()*vw;
              const y = Math.random()*vh;

              if(isVerySmall){
                const topZone = y < vh*0.25;
                const bottomZone = y>vh*0.75;
                const sideZone = x<vw*0.12||x>vw*0.88;
                if(!(topZone||bottomZone||sideZone)) continue;
              }

              if(x>=excl.left && x<=excl.right && y>=excl.top && y<=excl.bottom) continue;

              const el = document.createElement('div');
              el.className='tree';
              el.textContent='üéÑ';

              const size = Math.floor((isVerySmall?10:14)+Math.random()*(isVerySmall?28:50));
              el.style.fontSize = size+'px';
              el.style.left = (x/vw*100)+'%';
              el.style.top  = (y/vh*100)+'%';

              const rot=(Math.random()*40-20).toFixed(1)+'deg';
              el.style.setProperty('--rot', rot);

              el.style.opacity = (isVerySmall ? (0.25+Math.random()*0.5) : (0.35+Math.random()*0.6)).toFixed(2);
              if(size>36) el.style.filter='drop-shadow(0 10px 12px rgba(0,0,0,0.45))';
              if(!isVerySmall) el.classList.add('animate');

              treesLayer.appendChild(el);
              placed=true;
            }
          }
        }

        let treesResizeTimer = null;
        function refreshTrees(){
          const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
          const base = vw>1400?90:vw>1200?70:vw>900?50:vw>600?32:12;
          createTrees(base);
        }

        window.addEventListener('resize', ()=>{
          clearTimeout(treesResizeTimer);
          treesResizeTimer = setTimeout(()=>{
            refreshTrees();
            positionBulbsDeferred();
          }, 220);
        });

        window.addEventListener('orientationchange', ()=>{
          setTimeout(()=>{
            refreshTrees();
            positionBulbsDeferred();
          }, 240);
        });

        modalOk.addEventListener('click', () => {
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden','true');
          const title = modal.querySelector('.modal-title');
          const sub = modal.querySelector('.modal-sub');
          if(title) title.textContent = '¬°Felicidades!';
          if(sub) sub.textContent = 'Te ganaste un bono de';
        });

        // init
        createBulbs(BULB_COUNT);

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready
            .then(() => { positionBulbsDeferred(); refreshTrees(); })
            .catch(() => { positionBulbsDeferred(); refreshTrees(); });
        } else {
          positionBulbsDeferred();
          refreshTrees();
        }

        
        const stored = getStoredChoice();
        if(stored && stored.date === todayStr()){
          const bulbs = document.querySelectorAll('.bulb');
          if(typeof stored.index === 'number' && bulbs[stored.index]){
            bulbs[stored.index].classList.add('revealed');
          }
          showStoredModal(stored.bonus);
        }

      } catch (err) {
        console.error('Error inicializando guirnalda:', err);
      }
    }
  </script>
</body>
</html>
